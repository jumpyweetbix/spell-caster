{% extends "base.html" %} {% import 'bootstrap/wtf.html' as wtf %} {% block
app_content %}
<style>
  .crud {
    width: 32%;
  }

  .stats {
    box-shadow: 0 0 5px 0 rgba(0, 0, 0, 0.1);
    padding: 15px;
    margin-bottom: 10px;
  }
</style>

<div class="row page-head">
  <div class="col-md-5">
    <h1>{{ char.name }}</h1>
    <h3>A level {{ char.level }} {{ char.race }} {{ char._class.name }}</h3>
  </div>
  <div class="col-md-3">
    <div class="opts">
        <a class="opt btn btn-block btn-default" href="{{url_for('learn_spells') }}">Learn spells</a>
    </div>
    <div class="opts">
        <a class="opt btn btn-block btn-default" href="{{url_for('prepare_spells')}}">Prepare spells</a>
    </div>
</div>
  <div class="col-md-4">
    <div class="row">
      <a href="{{ url_for('create_char') }}" class="crud btn btn-success">New</a>
      <a href="{{ url_for('edit_char') }}" class="crud btn btn-default">Edit</a>
      <a href="{{ url_for('delete_char') }}" class="crud btn btn-danger"
        onclick="return confirm('Are you sure you want to delete this character? You cannot get them back!')">Delete</a>
    </div>
    <br />
    {{ wtf.quick_form(form) }}
  </div>
</div>
<hr>

<div class="row">
  <div class="col-md-4 stats">
    <h3 style="text-align:center">Stats</h3>
    <hr>
    <ul>
      <li>Race: <strong>{{ char.race }}</strong></li>
      <li>Level: <strong>{{ char.level }}</strong></li>
      <li>Proficiency Bonus: <strong>+{{ char.prof_bonus }}</strong></li>
      <li>Spell Casting Ability: <strong>{{ char.casting_ability }}</strong></li>
      <li>Ability modifier: <strong>+{{ char.ability_score }}</strong></li>
      <li>Spell Attack Bonus: <strong>{{ char.prof_bonus + char.ability_score }}</strong></li>
      <li>Spell Save DC: <strong>{{ char.level + char.prof_bonus + char.ability_score }}</strong></li>
    </ul>
    <div>
      {{ wtf.quick_form(resetSlotsForm)}}
    </div>
  </div>

  <div class="col-md-8" style="padding-bottom: 1em;">
    <div class="row">
      {% for lvl, spells in lvls.items() %}
      {% if spells|length > 0 %}
      <div class="col-md-3">
        <h3 class="btn btn-default" onclick="collapse_table('{{lvl}}')">{% if lvl == 0 %}Cantrips{% else %}Level {{lvl}}
          spells{% endif %}</h3>
        {% if lvl > 0 %}
        <div style="display:flex;" class="pb-2 align-items-baseline">
          <button class="btn btn-secondary" type="button" onclick="decrementValue('lvl_{{lvl}}')">-</button>
          <input name="lvl_{{lvl}}" id="lvl_{{lvl}}" style="width:50px; text-align:center;" class="form-control"
            value="{{slots[lvl-1]}}" />
          <button class="btn btn-secondary" type="button" onclick="incrementValue('lvl_{{lvl}}')">+</button>
        </div>
        {% endif %}
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>
</div>
<hr>

<div class="container" style="padding-bottom:2em">
  {% for lvl, spells in lvls.items() %}
  {% if spells|length > 0 %}
  <table style="display:none" class="spell-table" id="spell-table-{{lvl}}">
    <thead>
      <tr>
        <th>Name</th>
        <th>Level</th>
        <th>Concentration</th>
        <th>Cast Time</th>
        <th>Range</th>
        <th>Duration</th>
        <th>School</th>
      </tr>
    </thead>
    <tbody>
      {% for spell in spells %}
      <tr href="{{ url_for('view_spell', id=spell.id) }}">
        <td><a href="{{url_for('view_spell', id=spell.id)}}" target="_blank">{{spell.name}}</a></td>
        <td>{{spell.level}}</td>
        <td>{{spell.concentration}}</td>
        <td>{{spell.cast_time}}</td>
        <td>{{spell.spell_range}}</td>
        <td>{{spell.duration}}</td>
        <td>{{spell.school}}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
  {% endfor %}
</div>

</div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<script>
  $("th").click(function () {
    var table = $(this).parents("table").eq(0);
    var rows = table
      .find("tr:gt(0)")
      .toArray()
      .sort(comparer($(this).index()));
    this.asc = !this.asc;
    if (!this.asc) {
      rows = rows.reverse();
    }
    for (var i = 0; i < rows.length; i++) {
      table.append(rows[i]);
    }
  });
  function comparer(index) {
    return function (a, b) {
      var valA = getCellValue(a, index),
        valB = getCellValue(b, index);
      return $.isNumeric(valA) && $.isNumeric(valB)
        ? valA - valB
        : valA.toString().localeCompare(valB);
    };
  }
  function getCellValue(row, index) {
    return $(row).children("td").eq(index).text();
  }

  function collapse_table(id) {
    var table = document.getElementById('spell-table-' + id);
    var toggle = (table.style.display == '' ? 'none' : '');
    var tables = document.getElementsByClassName('spell-table');
    for (var i = 0; i < tables.length; i++) {
      tables[i].style.display = 'none';
    }
    table.style.display = toggle;
  }

  function incrementValue(id) {
    var value = parseInt(document.getElementById(id).value, 10);
    value = isNaN(value) ? 0 : value;
    value++;
    document.getElementById(id).value = value;
    changeSlot(id, value);
  }
  function decrementValue(id) {
    var value = parseInt(document.getElementById(id).value, 10);
    value = isNaN(value) ? 0 : value;
    if (value != 0) {
      value--;
      document.getElementById(id).value = value;
      changeSlot(id, value);
    }
  }
  function changeSlot(lvl, res) {
    data = { slot_lvl: lvl, slot_res: res };
    $.post({
      url: "{{ url_for('change_slot_val') }}",
      data: JSON.stringify(data, null, "\t"),
      contentType: "application/json;charset=UTF-8",
      success: function (result) {
        console.log(result);
      },
    });
  }

</script>

{% endblock %}